<!DOCTYPE html>
<html>
<head>
<title>Serverless with Media Demo</title>
<script src="webrtc/samples/web/js/adapter.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
</head>
<body>
<div id="question">
  Are you a <button onclick="show_caller()">Caller</button> or <button onclick="show_callee()">Callee</button>?
</div>
<div id="caller" style="display:none">
  <h2>Caller</h2>
  <button onclick="create_offer()">Create Offer</button><br>
  <div id="offer_widget" style="display:none">
    <p>Send the following offer to callee</p>
    <textarea id="offer"></textarea><br>
  </div>
  <div id="accept_answer" style="display:none">
    <textarea id="answer_for_acception" placeholder="paste answer generated by callee"></textarea><br>
    <button onclick="accept_answer()">Accept Answer</button><br>
  </div>
</div>
<div id="callee" style="display:none">
  <h2>Callee</h2>
  <textarea id="offer_for_answer" placeholder="paste offer generated by caller"></textarea><br>
  <button onclick="create_answer()">Create Answer from Offer</button><br>
  <div id="answer_widget" style="display:none">
    <p>Send the following answer to caller</p>
    <textarea id="answer"></textarea><br>
  </div>
</div>

<div id="output"></div>
<div id="msg" style="display:none">
  <audio autoplay></audio>
  <button id="enable_audio" onclick="enable_audio()"/>Enable Audio</button>
  <button id="disable_audio" onclick="disable_audio()" style="display:none" />Disable Audio</button>
  <br>
  <textarea id="input" disabled></textarea><br>
  <button onclick="send()">Send</button>
</div>

<script>
$('textarea').css({width: 600});
var is_page_active = true;
var unread_msg_interval;
var renegotiating = false;
var audio_stream;
var is_caller;
$(window).focus(function() {
  is_page_active = true;

  clearInterval(unread_msg_interval);
  unread_msg_interval = 0;
  document.title = 'Serverless Demo';
});
$(window).blur(function() {
  is_page_active = false;
});

var adj_height = function(textarea) {
  textarea.css({height: textarea[0].scrollHeight});
}

var show_caller = function() {
  is_caller = true;
  $('#caller').show();
  $('#question').hide();
};

var show_callee = function() {
  is_caller = false;
  $('#callee').show();
  $('#question').hide();
}

$('#input').on('keydown', function(e) {
  if (e.which == 13) {
    send();
    return false;
  }
});

var pc_config = webrtcDetectedBrowser === 'firefox' ?
  {'iceServers':[{'url':'stun:23.21.150.121'}]} : // IP address
  {'iceServers': [{'url': 'stun:stun.l.google.com:19302'}]};
var pc_constraints = {
  'optional': [
    {'DtlsSrtpKeyAgreement': true}
  ]
};
var sdp_constraints = {};
var pc = new RTCPeerConnection(pc_config, pc_constraints);
pc.onaddstream = function(e) {
  console.log('got stream');
  attachMediaStream($('audio')[0], e.stream);
  add_msg('Peer is now streaming media feed', {color: 'green'});
};
pc.onremovestream = function(e) {
  add_msg('Peer is no longer streaming media feed', {color: 'green'});
};
var data_channel;

var create_offer = function() {
  var candidates = [];
  var offer;
  data_channel = pc.createDataChannel("msg_channel", {reliable: true});
  handle_data_channel(data_channel);

  pc.onicecandidate = function(e) {
    if (!renegotiating && e.candidate) {
      candidates.push(e.candidate);
      display_offer();
    }
  };

  pc.createOffer(function(o) {
    offer = o;
    display_offer();
    pc.setLocalDescription(offer);
  }, on_signaling_error, sdp_constraints);

  var display_offer = function() {
    $('#offer').val(JSON.stringify({offer: offer, candidates: candidates}));
    adj_height($('#offer'));
    $('#offer_widget').show();
    $('#accept_answer').show();
  };
}

var handle_data_channel = function(c) {
  c.onopen = function() {
    $('#input')[0].disabled = false;
    $('#msg').show();
    add_msg('p2p channel created', {color: 'green'});
  };

  c.onmessage = function(e) {
    var msg = JSON.parse(e.data);

    if (msg.type == 'msg') {
      add_msg(msg.content, {color: 'red'});
      var dots = 1;
      if (!is_page_active && !unread_msg_interval) {
        unread_msg_interval = setInterval(function() {
          document.title = '.'.repeat(dots);
          dots = dots % 5 + 1;
        }, 300);
      }
    } else if (msg.type == 'offer') {
      console.log('got new offer');
      renegotiating = true;
      var offer = new RTCSessionDescription(msg.content);
      pc.setRemoteDescription(offer);
      pc.createAnswer(function(a) {
        pc.setLocalDescription(a);
        console.log('sending new answer..');
        data_channel.send(JSON.stringify({type: 'answer', content: a}));
      }, on_signaling_error, sdp_constraints);
    } else if (msg.type == 'answer') {
      console.log('got new answer');
      var answer = new RTCSessionDescription(msg.content);
      pc.setRemoteDescription(answer);
    } else if (msg.type == 'renegotiate') {
      renegotiate();
    }
  };

  c.onclose = function() {
    $('#input')[0].disabled = true;
    add_msg('peer has left the conversation', {color: 'green'});
    $('#msg').hide();
  };
};

var add_msg = function(msg, css) {
    $('<p>' + Date() + ': ' + msg + '</p>').css(css).appendTo('#output');
};

var create_answer = function() {
  var info = JSON.parse($('#offer_for_answer').val());
  var offer = new RTCSessionDescription(info.offer);
  var candidates = [];
  var remote_candidates = info.candidates;
  var answer;

  pc.setRemoteDescription(offer);
  $.each(remote_candidates, function(i, c) {
    var candidate = new RTCIceCandidate({sdpMLineIndex: c.sdpMLineIndex, candidate: c.candidate});
    pc.addIceCandidate(candidate);
  });

  pc.createAnswer(function(a) {
    answer = a;
    pc.setLocalDescription(answer);
    display_answer();
  }, on_signaling_error, sdp_constraints);

  pc.onicecandidate = function(e) {
    if (!renegotiating && e.candidate) {
      candidates.push(e.candidate);
      display_answer();
    }
  };

  pc.ondatachannel = function(e) {
    data_channel = e.channel;
    handle_data_channel(data_channel);
  };

  var display_answer = function() {
    $('#answer').val(JSON.stringify({answer: answer, candidates: candidates}));
    adj_height($('#answer'));
    $('#answer_widget').show();
  };
}

var on_signaling_error = function(e) {
  console.error('signaling error:' + e.name);
}

var accept_answer = function() {
  var info = JSON.parse($('#answer_for_acception').val());
  var answer = new RTCSessionDescription(info.answer);
  pc.setRemoteDescription(answer);
  $.each(info.candidates, function(i, c) {
    var candidate = new RTCIceCandidate({sdpMLineIndex: c.sdpMLineIndex, candidate: c.candidate});
    pc.addIceCandidate(candidate);
  });
};

var send = function() {
  var txt = $('#input').val();
  data_channel.send(JSON.stringify({type: 'msg', content: txt}));
  add_msg(txt, {color: 'blue'});
  $('#input').val('');
};

var enable_audio = function() {
  var constraints = { audio: true, video: false };
  var audio = $('audio')[0];
  var error_callback = function(e) {
    console.warn('getUserMedia error: '+ e);
  };

  var success_callback = function(stream) {
    audio_stream = stream;
    pc.addStream(stream);
    if (is_caller) {
      renegotiate();
    } else {
      data_channel.send(JSON.stringify({type: 'renegotiate'}));
    }
    
    $('#enable_audio').hide();
    $('#disable_audio').show();
  };

  getUserMedia(constraints, success_callback, error_callback);
};

var disable_audio = function() {
  pc.removeStream(audio_stream);
  if (is_caller) {
    renegotiate();
  } else {
    data_channel.send(JSON.stringify({type: 'renegotiate'}));
  }

  audio_stream.stop();
  $('#enable_audio').show();
  $('#disable_audio').hide();
};

var renegotiate = function() {
  console.log('renegotiating..');
  renegotiating = true;
  pc.createOffer(function(offer) {
    pc.setLocalDescription(offer);
    console.log('sending new offer..');
    data_channel.send(JSON.stringify({type: 'offer', content: offer}));
  }, on_signaling_error, sdp_constraints);
};
</script>
</body>
</html>
