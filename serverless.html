<!DOCTYPE html>
<html>
<head>
<title>Serverless Demo</title>
<script src="webrtc/samples/web/js/adapter.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
</head>
<body>
<div id="question">
  Are you a <button onclick="show_caller()">Caller</button> or <button onclick="show_callee()">Callee</button>?
</div>
<div id="caller" style="display:none">
  <h2>Caller</h2>
  <button onclick="create_offer()">Create Offer</button><br>
  <div id="offer_widget" style="display:none">
    <p>Send the following offer to callee</p>
    <textarea id="offer"></textarea><br>
  </div>
  <div id="accept_answer" style="display:none">
    <textarea id="answer_for_acception" placeholder="paste answer generated by callee"></textarea><br>
    <button onclick="accept_answer()">Accept Answer</button><br>
  </div>
</div>
<div id="callee" style="display:none">
  <h2>Callee</h2>
  <textarea id="offer_for_answer" placeholder="paste offer generated by caller"></textarea><br>
  <button onclick="create_answer()">Create Answer from Offer</button><br>
  <div id="answer_widget" style="display:none">
    <p>Send the following answer to caller</p>
    <textarea id="answer"></textarea><br>
  </div>
</div>

<div id="output"></div>
<div id="msg" style="display:none">
  <textarea id="input" disabled></textarea><br>
  <button onclick="send()">Send</button>
</div>

<script>
var show_caller = function() {
  $('#caller').show();
  $('#question').hide();
};

var show_callee = function() {
  $('#callee').show();
  $('#question').hide();
}

$('#input').on('keydown', function(e) {
  if (e.which == 13) {
    send();
    return false;
  }
});

var pc_config = webrtcDetectedBrowser === 'firefox' ?
  {'iceServers':[{'url':'stun:23.21.150.121'}]} : // IP address
  {'iceServers': [{'url': 'stun:stun.l.google.com:19302'}]};
var pc_constraints = {
  'optional': [
    {'DtlsSrtpKeyAgreement': true}
  ]
};
var sdp_constraints = {};
var pc = new RTCPeerConnection(pc_config, pc_constraints);
var data_channel;

var create_offer = function() {
  var candidates = [];
  data_channel = pc.createDataChannel("msg_channel", {reliable: true});
  handle_data_channel(data_channel);

  pc.onicecandidate = function(e) {
    if (e.candidate) {
      candidates.push(e.candidate);
    }
  };

  pc.createOffer(function(offer) {
    pc.setLocalDescription(offer);
    setTimeout(function() {
      // give it a some time to gather ICE candidates
      $('#offer').val(JSON.stringify({offer: offer, candidates: candidates}));
      $('#offer_widget').show();
      $('#accept_answer').show();
    }, 500);
  }, on_signaling_error, sdp_constraints);
}

var handle_data_channel = function(c) {
  c.onopen = function() {
    $('#input')[0].disabled = false;
    $('#msg').show();
    add_msg('p2p channel created', {color: 'green'});
  };

  c.onmessage = function(e) {
    add_msg(e.data, {color: 'red'});
  };

  c.onclose = function() {
    $('#input')[0].disabled = true;
    $('#msg').hide();
  };
};

var add_msg = function(msg, css) {
    $('<p>' + Date() + ': ' + msg + '</p>').css(css).appendTo('#output');
};

var create_answer = function() {
  var info = JSON.parse($('#offer_for_answer').val());
  var offer = new RTCSessionDescription(info.offer);
  var candidates = [];
  var remote_candidates = info.candidates;

  pc.setRemoteDescription(offer);
  $.each(remote_candidates, function(i, c) {
    var candidate = new RTCIceCandidate({sdpMLineIndex: c.sdpMLineIndex, candidate: c.candidate});
    pc.addIceCandidate(candidate);
  });

  pc.createAnswer(function(answer) {
    pc.setLocalDescription(answer);
    setTimeout(function() {
      // give it a some time to gather ICE candidates
      $('#answer').val(JSON.stringify({answer: answer, candidates: candidates}));
      $('#answer_widget').show();
    }, 500);
  }, on_signaling_error, sdp_constraints);

  pc.onicecandidate = function(e) {
    if (e.candidate) {
      candidates.push(e.candidate);
    }
  };

  pc.ondatachannel = function(e) {
    data_channel = e.channel;
    handle_data_channel(data_channel);
  };
}

var on_signaling_error = function(e) {
  console.error('signaling error:' + e.name);
}

var accept_answer = function() {
  var info = JSON.parse($('#answer_for_acception').val());
  var answer = new RTCSessionDescription(info.answer);
  pc.setRemoteDescription(answer);
  $.each(info.candidates, function(i, c) {
    var candidate = new RTCIceCandidate({sdpMLineIndex: c.sdpMLineIndex, candidate: c.candidate});
    pc.addIceCandidate(candidate);
  });
};

var send = function() {
  var txt = $('#input').val();
  data_channel.send(txt);
  add_msg(txt, {color: 'blue'});
  $('#input').val('');
};
</script>
</body>
</html>
